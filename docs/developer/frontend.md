<!-- 2 -->
# Frontend

The K-Link DMS frontend is a custom made solution built on top of [Skeleton](http://getskeleton.com/) 2.0.4 for the stylesheet. The javascript that enables the interaction with the user is a custom set of libraries that are glued toghether.

We opted to not use a framework for not sticking with decision made by others in terms of what features and browser to support and, also, to not deal with the framework release cycle. 


The supported browser are:

- IE9
- IE10
- IE11
- Microsoft Edge
- Chrome (desktop, latest) 
- Firefox (desktop, latest) 
- Safari (desktop, latest) 

## Frontend Folder structure

Frontend folders follows the Laravel folder structure: source files are stored under the `resources/assets` folder, while build files are created in the `public` folder.

	app
	...
	public
	|-- build *
	|-- images
	|-- js *
	|    +-- modules *
	resources
	|-- assets
	|    |-- js
	|    |    |-- deps **
	|    |    +-- modules
	|    |-- less
	|    |    +-- partials
	|    +-- vendor
	...

Folders marked with `*` are built by the build process. To understand why there is a build folder read the Laravel Elixir Documentation about "[Version / Hash A File](http://laravel.com/docs/5.0/elixir)" and its [helper](http://laravel.com/docs/5.0/helpers#miscellaneous).

`**` the `deps` folder stores dependencies that are not available on Bower or NPM or has been changes from what is available in the official repository.

All the new javascript source code must be put inside the `resources/assets/js` folder according to the contribution rules specified in the javascript section of this page.

All the new stylesheet source code must be put inside the `resources/assets/less` folder according to the contribution rules specified in the stylesheet section of this page.


## Compiling the latest version of the frontend

As stated in the [developer installation](./developer-installation) guide, the compiled files for the frontend are not commited in the GIT repository.

```bash
# install bower (is possible that you might need to use sudo)
npm install -g bower

# install Gulp (is possible that you might need to use sudo)
npm install -g gulp

# install the build system dependencies
npm install

# download and install the frontend libraries
bower install

# build
gulp
```

Laravel has a Gulp library called Elixir to handle the generation of the gulp tasks, so please refer to the official [Laravel Elixir documentation](http://laravel.com/docs/5.0/elixir) for further details.


## Javascript

Static dependencies are managed through Bower and stored in `resources/assets/vendor`, while DMS specific javascript files are in `resources\assets\js`.

Dynamic module loading is performed client side using RequireJS.

Javascript files are minified and concatenated by Gulp.

**Dependencies**

- jquery: ~1.11.2;
- requirejs: ~2.1;
- nprogress: ~0.1.6;
- material-design-icons: ~1.0.1;
- combokeys: [mightyiam/combokeys#2.3.0](https://github.com/PolicyStat/combokeys);
- sweetalert: 0.5.0 (recent version have dropped IE8 support);
- dropzone: ~4.0.1;
- jquery.serializeJSON: ~2.5.0;
- html5shiv: ~3.7.2;
- object.observe: ~0.2.4;
- es5-shim: ~4.1.0;
- shepherd: HubSpot/shepherd#~0.7.1;
- lodash: ~3.8.0;
- jquery-unveil: ~1.3.0;


Static dependencies are are concatenated in the `public/js/vendor.js` file that is automatically generated by gulp and included in every page. Static dependencies includes:

- jQuery
- requirejs
- NProgress
- Lodash
- JQuery serialize JSON plugin
- JQuery unveil plugin
- SweetAlert
- combokeys
- contextmenu
- DMS

Dynamic dependencies and scripts should respect the AMD specification as imposed by RequireJS. All the dynamic dependendencies must be loaded with RequireJS.

In the normal context of execution you will have access to the following preloaded modules (the name of the module is what needs to be used to require it):

- `jquery`
- `DMS`
- `lodash`
- `nprogress`
- `combokeys`
- `modernizr`
- `context`



### DMS Javascript API

The DMS javascript API offer helper methods to interact with the DMS services. 

Feature offered:

- Ajax calls to specific services updated according to the backend changes
- Navigation
- Modal Windows and Dialogs
- Loading progress and long running messages

The DMS object is available through requirejs and is named `DMS`:

```js
require(['DMS'], function(DMS){

	// ... your code here ...
    
});
```

What's inside the DMS object:

- `DMS.Ajax`: methods for making get, post, put, delete requests via Ajax;
- `DMS.Paths`: constants for services URL;
- `DMS.MessageBox`: modal window related methods
- `DMS.Utils`: some utilities
- `DMS.Progress`: for showing and hiding the overall progress bar
- `DMS.Services`: the DMS exposed services utility methods
- some navigation helper methods.


#### Navigation helper methods and `DMS.Utils`

`DMS.navigate(path:String, getParams:Object, full:boolean)`

Perform a page navigation to the specified `path`. `path` could be a relative path to the current DMS instance location, or an absolute URL. If set as an absolute url set the `full` parameter to `true`.

`getParams` is an object describing the parameter that must be added to the get request. Parameter serialization is performed by [`jQuery.param()`](http://api.jquery.com/jquery.param/#jQuery-param-obj) function.

`DMS.navigateReload()`

Reloads the current page



`DMS.Utils.countKeys(obj:object) : Number`

Will count how may keys are in the specified object, `obj`.

`DMS.Utils.inArray(arr:array, what:object|string) : boolean`

Determine if the specified `what` is in the array `arr`. The implementation uses [Array.prototype.indexOf](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf) if available, otherwise will fallback to [jQuery.inArray](http://api.jquery.com/jquery.inArray/).




##### DMS.Ajax

DMS Ajax includes some simple wrapper around jQuery.ajax method that will configure the needed parameters to pass the request validation performed by the backend and to get the response in JSON format.

The DMS.Ajax has the following functions:

- `get(url, params, success, error)` perform a get request
- `post(url, params, success, error)`  perform a post request
- `put(url, params, success, error)`  perform a put request
- `delete(url, success, error)`  perform a delete request

every function returns the jqXHR object, the `params` parameter is an object that will be passed as payload to the Ajax request. `success` is the jQuery success callback, while `error` is the jQuery error callback.


##### DMS.Paths

Store the constants that defines the DMS routes for the backend API services.

- `DMS.Paths.STARRED`: 'documents/starred' endpoint route
- `DMS.Paths.SEARCH`: 'search' endpoint route
- `DMS.Paths.IMPORT`: 'documents/import' endpoint route
- `DMS.Paths.DOCUMENTS`: 'documents' endpoint route
- `DMS.Paths.UPLOAD_FALLBACK`: 'documents/create' endpoint route
- `DMS.Paths.GROUPS`: 'documents/groups' endpoint route
- `DMS.Paths.GROUPS_CREATE`: 'documents/groups/create' endpoint route
- `DMS.Paths.GROUPS_EDIT`: 'documents/groups/{ID}/edit' endpoint route. {ID} parameter required. To use it replace('{ID}', 'your_value')
- `DMS.Paths.SHARES`: 'shares'  endpoint route
- `DMS.Paths.SHARE_CREATE`: 'shares/create' endpoint route
- `DMS.Paths.STORAGE_REINDEX_ALL`: 'administration/storage/reindex-all' endpoint route
- `DMS.Paths.USER_PROFILE_OPTIONS`: 'profile/options' endpoint route
- `DMS.Paths.MAP_SEARCH`: 'visualizationdata' endpoint route. This is used only by the map visualization
- `DMS.Paths.PEOPLE`: 'people' endpoint route

`DMS.Paths.fullUrl(path:String) : String`

Returns the absolute URL for the given path according to the current DMS instance base URL.



##### DMS.MessageBox

- `DMS.MessageBox.success: function(title:string, text:string) : Promise`: shows a succesfull message
- `DMS.MessageBox.error: function(title:string, text:string) : Promise`: shows an error message
- `DMS.MessageBox.warning: function(title:string, text:string) : Promise`: shows a warning message
- `DMS.MessageBox.show: function(title:string, text:string) : Promise`: shows a generic modal window
- `DMS.MessageBox.close: function() : Promise`: close the current opened modal window
- `DMS.MessageBox.wait: function(title, text) : Promise`: shows a modal windows that cannot be closed from the UI as a wait/loading indicator
- `DMS.MessageBox.deleteQuestion: function(title, text, options) : Promise`: 
- `DMS.MessageBox.question: function(title, text, cofirmBtnText, cancelBtnText, callback) : Promise`: 
- `DMS.MessageBox.prompt: function(title, text, placeholder, callback) : Promise`: 

See SweetAlert2 for a the specific documentation of the options parameter and the returned Promise


##### DMS.Progress

`DMS.Progress.start()`

Start showing the overall progress bar on top of the page.

`DMS.Progress.done()`

Completes and hides the overall progress bar on top of the page.


##### DMS.Services


for required and optional parameters of a specific service please refer to the backend API page


`DMS.Services.Starred`

Handle starring and unstarring document descriptors

`add(data:object, success:callback, error:callback)` 

add a star to a document descriptor. The user is inferred by the current session.

The data object has the following keys:
- `institution:String`: the K-Link Institution identifier of the document descriptor;
- `descriptor:String`: the K-Link Local Document Id of the document descriptor;
- `visibility`: the visibility of the document descriptor to star. Could be`public` or `private`.

`remove(starId:number, success, error)`

Deletes a star, identified by its `starId`


`DMS.Services.Bulk`

Bulk operations

`remove(data, success, error)`

remove documents

`copyTo(data, success, error)`

copy documents to collection

`restore(data, success, error)`

restore documents from trash

`makePublic(data, success, error)`

make documents publicly available on the K-Link Network

`DMS.Services.Documents`

`update(id, data, success, error)`

updates a document descriptor

`remove(id, success, error)`

remove a document descriptor (put in trash)

`openEditPage(id)`

open document descriptor edit page

`visualizationSearch(arg_obj, success, error)`

used by the map visualization


`DMS.Services.Groups`

Handle operation on Collections

`create(data, success, error)`

`update(id, data, success, error)`

`remove(id, success, error)`

`open(id)`


`DMS.Services.Shared`

Handle operation inside the shared section

`openGroup(id)`

`remove(id, success, error)`


`DMS.Services.PeopleGroup`

Handle People Groups

`addGroup(name, success, error)`

`addUser(groupId, userId, success, error)`

`removeUser(groupId, userId, success, error)`

`removeGroup(groupId, success, error)`

`renameGroup(groupId, name, success, error)`

`makePersonal(groupId, success, error)`

`makeInstitutional(groupId, success, error)`


`DMS.Services.Options`

Actions related to user's options

`saveListStyle(style, success, error)` 

Change the option for the documents list visualization.

the `style` parameter could have one of the following values `details`, `tiles` or `cards`




### Adding a new Javascript module and requiring it

...

### Default modules and how to require them in your module

...



## Stylesheet

The stylesheet for the K-Link DMS is written using the LESS preprocessor. LESS source files are stored in `resources/assets/less` folder.

The `app.less` file contains the main variables for the style and requires all the dependencies and components style. Components are located in `resources/assets/less/partials` folder.

For grids, buttons, typography and so on refer to [Skeleton Documentation](http://getskeleton.com)


**On the CSS/Less side there is an in-progress change to use BEM and the new K-Link Styleguide**. To make the transition happy the partials might contain new files prefixed 
with `new`. The new files mark the work in progress to update the frontend styling to something more maintainable.


## Modules

### Panels

Handle show/hide for details panels and dialog screen. Do not handle question, error, warning and info modal dialogs. Those are handled via SweetAlert and the 
[DMS Javascript API main module](#dms-javascript-api)

